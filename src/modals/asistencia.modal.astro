---
interface Props {
  nroWhatsapp: string;
}
const { nroWhatsapp } = Astro.props;
---

<div id="modalAsistencia" class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-md modal-dialog-centered">

    <div class="modal-content">

      <div class="modal-content-2">

        <picture>
          <source type="image/webp" srcset="/flores_Grupo04_A.webp">
          <source type="image/png" srcset="/flores_Grupo04_A.png">
          <img class="adorno adorno-1 aos-init aos-animate" data-aos="fade-right" data-aos-delay="300" data-aos-duration="1000" data-aos-once="false" src="/flores_Grupo04_A.png" alt="" loading="lazy">
        </picture>


        <picture>
          <source type="image/webp" srcset="/flores_Grupo04_B.webp">
          <source type="image/png" srcset="/flores_Grupo04_B.png">
          <img class="adorno adorno-2 aos-init aos-animate" data-aos="fade-right" data-aos-delay="400" data-aos-duration="1000" data-aos-once="false" src="/flores_Grupo04_B.png" alt="" loading="lazy">
        </picture>

        <div class="img-top-modal d-flex justify-content-center align-items-start">

          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">√ó</span>
          </button>

          <div class="white-circle-icon">
            <img class="" src="/img_circuloFiesta.svg" alt="">
          </div>

        </div>

        <div class="modal-header">
          <h5 class="modal-title"></h5>
        </div>

        <div class="modal-body">


          <div class="formulario-content">

            <form id="formAsistencia" action="">


              <div class="form-group d-flex justify-content-around custom-control custom-radio custom-control-inline">
                <div class="form-check">
                  <input class="form-check-input custom-control-input" type="radio" name="asistencia" id="1" value="Si" checked="">
                  <label class="form-check-label custom-control-label" for="1">
                    ¬°S√≠, confirmo!                  </label>
                </div>
                <div class="form-check">
                  <input class="custom-control-input" type="radio" name="asistencia" id="2" value="No">
                  <label class="custom-control-label" for="2">
                    No puedo :(                  </label>
                </div>
              </div>

              <div class="form-group">
                <input type="text" class="form-control" id="nombreAsistente" name="nombre" placeholder="Ingrese su nombre completo">
              </div>


              <div class="form-group">
                <textarea id="comentariosAsistente" class="form-control" name="comentarios" rows="2" placeholder="Ingrese alg√∫n dato importante. Ej: Soy vegetariano"></textarea>
              </div>

              <input id="eventoAsistencia" type="hidden" name="evento" value="">
              <input type="hidden" name="invitacion" value="">
              <input type="hidden" name="token" value="">
              <input type="hidden" name="lang" value="es">
              <input type="hidden" name="country" value="ar">

            </form>

          </div>

          <div class="msj-content d-flex flex-column justify-content-center"></div>

        </div>

        <div class="modal-footer">
          <button type="button" id="sendAsistencia" class="boton">Enviar</button>
        </div>

      </div>
    </div>


  </div>
</div>

<script >
  // Abrir modal
  $('body').on('click', 'a.confirmar-asistencia', function(e) {

    e.preventDefault();
    $("#error-form").remove();

    var evento = $(this).attr('data-evento');
    $('#eventoAsistencia').val(evento!);

    var rutaImgModalAsistencia = '/img_circuloFiesta.svg';
    $('#modalAsistencia .modal-title').text("¬øConfirmas asistencia?");
    $('#modalAsistencia .img-top-modal img').attr('src', rutaImgModalAsistencia!);

    //@ts-ignore
    $('#modalAsistencia').modal({
      backdrop: 'static'
    })
  });

  function isOkAsistencia() {
    $("#error-form").remove();
    
    var flag = true;
    var err = '';

    //@ts-ignore
    // Variables del form para validar.
    var asistenteName = $("#nombreAsistente").val().trim();
    //@ts-ignore
    var asistenteComentarios = $("#comentariosAsistente").val().trim();

    // Nombre
    if (asistenteName == '') {
      flag = false;
      err = "Es necesario ingresar un nombre para confirmar tu asistencia.";
    } 
    else {
      if (asistenteName.length > 100) {
        flag = false;
        err = "El nombre no puede tener m√°s de 100 caracteres.";
      }
    }

    // Comentarios
    if (asistenteComentarios != '') {
      if (asistenteComentarios.length > 100) {
        flag = false;
        err = "Los comentarios no pueden tener m√°s de 100 caracteres.";
      }
    }

    // Si hay error
    if (flag === false) {
      $('#formAsistencia').after('<span id="error-form">' + err + '</span>');
    }

    return flag;
  }

//   $('body').on('click', '#sendAsistencia', function(e) {

//     e.preventDefault();
//     if (isOkAsistencia()){
//       // Load and disabled buttom.
//       $("#sendAsistencia").text("Informando asistencia" + "...");
//       $("#sendAsistencia").prop("disabled", true);

//       var formulario = $("#formAsistencia")[0];
//       // Obtengo los datos del formulario
//       //@ts-ignore
//       var datos = new FormData(formulario);

//       // Visualizar como viajan los datos
//       for (var pair of datos.entries()) {
//         console.log(pair[0] + ", " + pair[1]);
//       }

//       const asistenciaText = datos.get('asistencia') === 'Si' 
//         ? '*¬°Confirmo mi asistencia al 15!* üéâ' 
//         : '*No podr√© asistir al 15.* üòî';

//       const mensaje = `
// Hola! ${asistenciaText}

// üë§ Nombre: ${datos.get('nombre')}
// üí¨ Comentarios: ${datos.get('comentarios') || 'Sin comentarios'}`.trim();
//       const numero = "5491141870588";
//       const url = `https://wa.me/${numero}?text=${encodeURIComponent(mensaje)}`;

//       window.open(url, "_blank");

//       // // Envio con fetch los datos mediante POST
//       // fetch(_pathApp + "producto/fetchs/confirmar-asistencia.php", {
//       //     method: "POST",
//       //     body: datos
//       //   })
//       //   // Promesas fetch
//       //   .then(res => res.json())
//       //   .then(data => {

//       //     // Si recibo error 
//       //     if (data.error === true) {

//       //       $("#sendAsistencia").text(lang_confirmarAsistencia);
//       //       $("#sendAsistencia").prop("disabled", false);

//       //       // Imprimo el error
//       //       $('#formAsistencia').after('<span id="error-form">' + data.desc + '</span>');
//       //     }

//       //     // Si no hay error 
//       //     if (data.error === false) {

//       //       $("#sendAsistencia").text(lang_confirmarAsistencia);
//       //       $("#sendAsistencia").prop("disabled", false);


//       //       // Oculto elementos del form y reseteo
//       //       $('#formAsistencia')[0].reset();
//       //       $('#modalAsistencia .formulario-content, #modalAsistencia .modal-footer, #modalAsistencia h5').hide();



//       //       // Acomodo el css para centrar mensaje
//       //       $('#modalAsistencia .modal-body').addClass('fix-height');

//       //       // Muestro mensaje de exito
//       //       $('#modalAsistencia .msj-content').html(
//       //         "<h5>" + lang_asistenciaMsjExito_1 + "</h5><p>" + lang_asistenciaMsjExito_2 + "</p>"
//       //       ).show();


//       //       // Cierro modal y vuelvo a activar form
//       //       setTimeout(function() {

//       //         $('#modalAsistencia').modal('hide');
//       //         $('#modalAsistencia .formulario-content, #modalAsistencia .modal-footer, #modalAsistencia h5').show();
//       //         $('#modalAsistencia .msj-content').html('').hide();
//       //         $('#modalAsistencia .modal-body').removeClass('fix-height');

//       //       }, 4000);

//       //     }

//         // });
//     }
//   });
$('body').on('click', '#sendAsistencia', function(e) {
    e.preventDefault();

    if (isOkAsistencia()) {
        // 1. Estado de carga en el bot√≥n
        const $btn = $("#sendAsistencia");
        const textoOriginal = $btn.text(); // Guardamos el texto original (ej: "Confirmar")
        
        $btn.text("Abriendo WhatsApp...").prop("disabled", true);

        // 2. Obtenci√≥n de datos
        const formulario = $("#formAsistencia")[0];
        //@ts-ignore
        const datos = new FormData(formulario);

        // 3. Construcci√≥n del mensaje (Pegado al margen izquierdo para evitar sangr√≠as)
        const asistenciaText = datos.get('asistencia') === 'Si' 
            ? '‚úÖ *¬°Confirmo mi asistencia al 15!* üéâ' 
            : '‚ùå *No podr√© asistir al 15.* üòî';

        const mensaje = `¬°Hola! ${asistenciaText}

üë§ *Nombre:* ${datos.get('nombre')}
${datos.get('comentarios') ? `üí¨ *Comentarios:* ${datos.get('comentarios')}` : ''}`.trim();

        const numero = "5491141870588";
        const url = `https://wa.me/${numero}?text=${encodeURIComponent(mensaje)}`;

        // 4. EJECUCI√ìN: Abrir WhatsApp
        window.open(url, "_blank");

        // 5. L√ìGICA DE √âXITO (Lo que antes estaba en el fetch)
        
        // Reset del bot√≥n
        $btn.text(textoOriginal).prop("disabled", false);

        // Ocultar elementos del form y resetear
        //@ts-ignore
        $('#formAsistencia')[0].reset(); // Si usas jQuery: $('#formAsistencia')[0].reset();
        $('#modalAsistencia .formulario-content, #modalAsistencia .modal-footer, #modalAsistencia h5').hide();

        // Acomodo el css para centrar mensaje
        $('#modalAsistencia .modal-body').addClass('fix-height');

        // Muestro mensaje de √©xito (Pod√©s usar tus variables lang_...)
        $('#modalAsistencia .msj-content').html(
            "<h5>¬°Muchas gracias!</h5><p>Tu mensaje de confirmaci√≥n se ha generado correctamente.</p>"
        ).show();

        // Cierre autom√°tico del modal y reset de su estado visual
        setTimeout(function() {
          //@ts-ignore
          $('#modalAsistencia').modal('hide');
          
          // Importante: Volver a mostrar los campos para la pr√≥xima vez que se abra
          $('#modalAsistencia .formulario-content, #modalAsistencia .modal-footer, #modalAsistencia h5').show();
          $('#modalAsistencia .msj-content').html('').hide();
          $('#modalAsistencia .modal-body').removeClass('fix-height');
        }, 4000);
    }
});
</script>