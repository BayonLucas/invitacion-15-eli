---
interface Props {
  nroWhatsapp: string;
}
const { nroWhatsapp } = Astro.props;
---

<div id="modalAsistencia" class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-content-2">
        <picture>
          <source type="image/webp" srcset="/flores_Grupo04_A.webp">
          <source type="image/png" srcset="/flores_Grupo04_A.png">
          <img class="adorno adorno-1 aos-init aos-animate" data-aos="fade-right" data-aos-delay="300" data-aos-duration="1000" data-aos-once="false" src="/flores_Grupo04_A.png" alt="" loading="lazy">
        </picture>

        <picture>
          <source type="image/webp" srcset="/flores_Grupo04_B.webp">
          <source type="image/png" srcset="/flores_Grupo04_B.png">
          <img class="adorno adorno-2 aos-init aos-animate" data-aos="fade-right" data-aos-delay="400" data-aos-duration="1000" data-aos-once="false" src="/flores_Grupo04_B.png" alt="" loading="lazy">
        </picture>

        <div class="img-top-modal d-flex justify-content-center align-items-start">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span inert>√ó</span>
          </button>
          <div class="white-circle-icon">
            <img class="" src="/img_circuloFiesta.svg" alt="">
          </div>
        </div>

        <div class="modal-header">
          <h5 class="modal-title"></h5>
        </div>

        <div class="modal-body">
          <div class="formulario-content">
            <form id="formAsistencia" action="">
              <div class="form-group d-flex justify-content-around custom-control custom-radio custom-control-inline">
                <div class="form-check ps-0">
                  <input class="custom-control-input" type="radio" name="asistencia" id="1" value="Si" checked="">
                  <label class="custom-control-label" for="1">
                    ¬°S√≠, confirmo!
                  </label>
                </div>
                <div class="form-check ps-0">
                  <input class="custom-control-input" type="radio" name="asistencia" id="2" value="No">
                  <label class="custom-control-label" for="2">
                    No puedo :(
                  </label>
                </div>
              </div>

              <div class="form-group">
                <input type="text" class="form-control" id="nombreAsistente" name="nombre" placeholder="Ingrese su nombre completo">
              </div>

              <div class="form-group">
                <textarea id="comentariosAsistente" class="form-control" name="comentarios" rows="2" placeholder="Ingrese alg√∫n dato importante. Ej: Soy vegetariano"></textarea>
              </div>

              <input id="eventoAsistencia" type="hidden" name="evento" value="">
              <input type="hidden" name="invitacion" value="">
              <input type="hidden" name="token" value="">
              <input type="hidden" name="wp" value={nroWhatsapp}>

            </form>
          </div>
          <div class="msj-content d-flex flex-column justify-content-center"></div>
        </div>

        <div class="modal-footer">
          <button type="button" id="sendAsistencia" class="boton">Enviar</button>
        </div>

      </div>
    </div>
  </div>
</div>

<script >
  // Abrir modal
  $('body').on('click', 'a.confirmar-asistencia', function(e) {

    e.preventDefault();
    $("#error-form").remove();

    var evento = $(this).attr('data-evento');
    $('#eventoAsistencia').val(evento!);

    var rutaImgModalAsistencia = '/img_circuloFiesta.svg';
    $('#modalAsistencia .modal-title').text("¬øConfirmas asistencia?");
    $('#modalAsistencia .img-top-modal img').attr('src', rutaImgModalAsistencia!);

    //@ts-ignore
    $('#modalAsistencia').modal({
      backdrop: 'static'
    })
  });

  function isOkAsistencia() {
    $("#error-form").remove();
    
    var flag = true;
    var err = '';

    //@ts-ignore
    // Variables del form para validar.
    var asistenteName = $("#nombreAsistente").val().trim();
    //@ts-ignore
    var asistenteComentarios = $("#comentariosAsistente").val().trim();

    // Nombre
    if (asistenteName == '') {
      flag = false;
      err = "Es necesario ingresar un nombre para confirmar tu asistencia.";
    } 
    else {
      if (asistenteName.length > 100) {
        flag = false;
        err = "El nombre no puede tener m√°s de 100 caracteres.";
      }
    }

    // Comentarios
    if (asistenteComentarios != '') {
      if (asistenteComentarios.length > 100) {
        flag = false;
        err = "Los comentarios no pueden tener m√°s de 100 caracteres.";
      }
    }

    // Si hay error
    if (flag === false) {
      $('#formAsistencia').after('<span id="error-form">' + err + '</span>');
    }

    return flag;
  }

$('body').on('click', '#sendAsistencia', function(e) {
    e.preventDefault();

    if (isOkAsistencia()) {
        const $btn = $("#sendAsistencia");
        const textoOriginal = $btn.text();
        
        $btn.text("Abriendo WhatsApp...").prop("disabled", true);

        const formulario = $("#formAsistencia")[0];
        //@ts-ignore
        const datos = new FormData(formulario);

        // L√≥gica de mensaje (siempre pegado al margen izquierdo)
        const asistenciaText = datos.get('asistencia') === 'Si' 
            ? '‚úÖ *¬°Confirmo mi asistencia al 15!* üéâ' 
            : '‚ùå *No podr√© asistir al 15.* üòî';

        const mensaje = `¬°Hola! ${asistenciaText}

üë§ *Nombre:* ${datos.get('nombre')}
${datos.get('comentarios') ? `üí¨ *Comentarios:* ${datos.get('comentarios')}` : ''}`.trim();

        const url = `https://wa.me/${datos.get('wp')}?text=${encodeURIComponent(mensaje)}`;

        // Abrir WhatsApp
        window.open(url, "_blank");

        // --- L√ìGICA DE √âXITO PARA EL REGRESO DEL USUARIO ---

        // 1. Resetear el bot√≥n principal por si acaso
        $btn.text(textoOriginal).prop("disabled", false);

        // 2. Ocultar el formulario
        $('#formAsistencia').hide(); 
        $('#modalAsistencia .modal-footer, #modalAsistencia h5').hide();

        // 3. Mostrar el mensaje de √©xito con un BOT√ìN DE CIERRE
        $('#modalAsistencia .msj-content').html(`
            <div class="text-center">
                <h5 class="mb-3">¬°Asistencia informada!</h5>
                <p>Tu mensaje se ha generado correctamente. Si no se abri√≥ WhatsApp, intenta de nuevo.</p>
                <button type="button" id="btnCerrarExito" class="boton">Cerrar</button>
            </div>
        `).show();

        $('#modalAsistencia .modal-body').addClass('fix-height');
    }
});

$('body').on('click', '#btnCerrarExito', function() {
    //@ts-ignore
    $('#modalAsistencia').modal('hide');

    setTimeout(function() {
      //@ts-ignore
      $('#formAsistencia')[0].reset();
      $('#formAsistencia').show();
      $('#modalAsistencia .modal-footer, #modalAsistencia h5').show();
      $('#modalAsistencia .msj-content').html('').hide();
      $('#modalAsistencia .modal-body').removeClass('fix-height');
    }, 500); 
});
</script>